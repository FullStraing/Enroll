<!doctype html>
<html lang="ru">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Регистрация — Enroll AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="min-h-screen bg-[#0B0F19] text-white">
    <main class="mx-auto flex min-h-screen max-w-xl flex-col justify-center px-6 py-12">
      <div class="mb-8">
        <h1 class="text-3xl font-semibold tracking-wide">Enroll AI</h1>
        <p class="mt-2 text-sm text-slate-300">Создай аккаунт и начни работу.</p>
      </div>
      <div class="rounded-2xl border border-[rgba(255,255,255,0.08)] bg-[rgba(255,255,255,0.04)] p-6">
        <label class="text-xs font-semibold text-slate-300">Username</label>
        <input id="reg-username" class="mt-2 w-full rounded-lg border border-slate-700 bg-transparent px-3 py-2 text-sm text-white" />
        <label class="mt-4 block text-xs font-semibold text-slate-300">Email</label>
        <input id="reg-email" type="email" class="mt-2 w-full rounded-lg border border-slate-700 bg-transparent px-3 py-2 text-sm text-white" />
        <label class="mt-4 block text-xs font-semibold text-slate-300">Password</label>
        <input id="reg-password" type="password" class="mt-2 w-full rounded-lg border border-slate-700 bg-transparent px-3 py-2 text-sm text-white" />
        <button id="register-btn" class="mt-6 w-full rounded-lg bg-[#22D3EE] px-4 py-2 text-sm font-semibold text-[#05111f] shadow-[0_0_18px_rgba(34,211,238,0.45)] transition hover:shadow-[0_0_28px_rgba(34,211,238,0.7)]">
          Создать аккаунт
        </button>
        <p id="register-status" class="mt-3 text-xs text-slate-300"></p>
      </div>
      <div class="mt-6 text-sm text-slate-300">
        Уже есть аккаунт? <a class="text-[#A78BFA] underline" href="/login">Войти</a>
      </div>
    </main>
    <script>
      const tokenKey = "enroll_token";
      const refreshKey = "enroll_refresh";
      const cookieMaxAge = 60 * 60 * 24 * 30;
      const statusEl = document.getElementById("register-status");

      function setStatus(text, isError = false) {
        statusEl.textContent = text;
        statusEl.className = isError ? "mt-3 text-xs text-red-300" : "mt-3 text-xs text-slate-300";
      }

      async function register() {
        setStatus("Регистрируем...");
        try {
          const payload = {
            username: document.getElementById("reg-username").value.trim(),
            email: document.getElementById("reg-email").value.trim(),
            password: document.getElementById("reg-password").value,
          };
          const response = await fetch("/api/auth/register/", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          if (!response.ok) {
            const err = await response.json();
            throw new Error(err.detail || JSON.stringify(err));
          }
          const loginResponse = await fetch("/api/auth/token/", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              username: payload.username,
              password: payload.password,
            }),
          });
          if (!loginResponse.ok) {
            throw new Error("Регистрация успешна, но вход не выполнен.");
          }
          const data = await loginResponse.json();
          localStorage.setItem(tokenKey, data.access);
          localStorage.setItem(refreshKey, data.refresh || "");
          document.cookie = `${tokenKey}=${data.access}; Path=/; Max-Age=${cookieMaxAge}; SameSite=Lax`;
          window.location.href = "/dashboard/";
        } catch (error) {
          setStatus(error.message, true);
        }
      }

      document.getElementById("register-btn").addEventListener("click", register);
    </script>
  </body>
</html>
