<!doctype html>
<html lang="ru">
  <head>
    <meta charset="utf-8" />
    <title>Applications (MVP)</title>
    <style>
      body { font-family: Arial, sans-serif; margin: 24px; background: #f7f7fb; }
      h1 { margin-bottom: 8px; }
      .card { background: white; padding: 16px; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); margin-bottom: 16px; }
      label { display: block; margin-top: 8px; font-weight: 600; }
      input, select { width: 100%; padding: 8px; margin-top: 4px; }
      button { margin-top: 12px; padding: 8px 12px; }
      table { width: 100%; border-collapse: collapse; }
      th, td { border-bottom: 1px solid #e0e0e0; padding: 8px; text-align: left; }
      .hint { color: #666; font-size: 0.9rem; }
      .error { color: #c62828; }
      .success { color: #2e7d32; }
    </style>
  </head>
  <body>
    <h1>Applications (MVP)</h1>
    <p class="hint">Минимальная страница для проверки Applications API через браузер.</p>

    <div class="card">
      <label for="token">JWT access token</label>
      <input id="token" type="text" placeholder="Bearer token" />
      <button id="load">Загрузить список</button>
      <div id="load-status" class="hint"></div>
    </div>

    <div class="card">
      <h2>Создать Application</h2>
      <label for="university-id">University ID (если из базы)</label>
      <input id="university-id" type="number" placeholder="Например, 1" />
      <label for="university-name">University name (если вручную)</label>
      <input id="university-name" type="text" placeholder="Например, Example University" />
      <label for="deadline">Deadline</label>
      <input id="deadline" type="date" />
      <label for="status">Status</label>
      <select id="status">
        <option value="planned">planned</option>
        <option value="in_progress">in_progress</option>
        <option value="submitted">submitted</option>
      </select>
      <button id="create">Создать</button>
      <div id="create-status" class="hint"></div>
    </div>

    <div class="card">
      <h2>Список Applications</h2>
      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>University</th>
            <th>Deadline</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody id="applications"></tbody>
      </table>
    </div>

    <script>
      const applicationsEl = document.getElementById('applications');
      const tokenEl = document.getElementById('token');
      const loadBtn = document.getElementById('load');
      const createBtn = document.getElementById('create');
      const loadStatus = document.getElementById('load-status');
      const createStatus = document.getElementById('create-status');

      function authHeader() {
        const token = tokenEl.value.trim();
        return token ? { Authorization: `Bearer ${token}` } : {};
      }

      function renderRows(items) {
        applicationsEl.innerHTML = '';
        items.forEach((item) => {
          const row = document.createElement('tr');
          const uniName = item.university ? item.university.name : item.university_name;
          row.innerHTML = `
            <td>${item.id}</td>
            <td>${uniName || '-'}</td>
            <td>${item.deadline_date || '-'}</td>
            <td>${item.status}</td>
          `;
          applicationsEl.appendChild(row);
        });
      }

      async function loadApplications() {
        loadStatus.textContent = 'Загрузка...';
        loadStatus.className = 'hint';
        try {
          const response = await fetch('/api/applications/', {
            headers: {
              'Content-Type': 'application/json',
              ...authHeader(),
            }
          });
          if (!response.ok) {
            throw new Error(`Ошибка загрузки: ${response.status}`);
          }
          const data = await response.json();
          renderRows(data);
          loadStatus.textContent = 'Готово.';
          loadStatus.className = 'success';
        } catch (error) {
          loadStatus.textContent = error.message;
          loadStatus.className = 'error';
        }
      }

      async function createApplication() {
        createStatus.textContent = 'Создание...';
        createStatus.className = 'hint';
        const payload = {
          university_id: document.getElementById('university-id').value || null,
          university_name: document.getElementById('university-name').value,
          deadline_date: document.getElementById('deadline').value || null,
          status: document.getElementById('status').value,
        };
        if (payload.university_id) {
          payload.university_id = Number(payload.university_id);
        } else {
          delete payload.university_id;
        }
        try {
          const response = await fetch('/api/applications/', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              ...authHeader(),
            },
            body: JSON.stringify(payload),
          });
          if (!response.ok) {
            const err = await response.json();
            throw new Error(err.detail || JSON.stringify(err));
          }
          createStatus.textContent = 'Создано.';
          createStatus.className = 'success';
          await loadApplications();
        } catch (error) {
          createStatus.textContent = error.message;
          createStatus.className = 'error';
        }
      }

      loadBtn.addEventListener('click', loadApplications);
      createBtn.addEventListener('click', createApplication);
    </script>
  </body>
</html>
