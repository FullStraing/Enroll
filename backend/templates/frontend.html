<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Enroll MVP Console</title>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;600&display=swap");

      :root {
        --ink: #1a1a1a;
        --muted: #5a5f6a;
        --panel: #ffffff;
        --accent: #2f6bff;
        --accent-2: #ffb84d;
        --border: #e5e7ef;
        --success: #1b8f5a;
        --danger: #c64242;
        --shadow: 0 12px 30px rgba(17, 24, 39, 0.12);
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: "Space Grotesk", "Segoe UI", sans-serif;
        color: var(--ink);
        background:
          radial-gradient(circle at 15% 10%, rgba(47, 107, 255, 0.15), transparent 45%),
          radial-gradient(circle at 85% 20%, rgba(255, 184, 77, 0.18), transparent 40%),
          linear-gradient(120deg, #f6f7fb 0%, #eef1ff 100%);
        min-height: 100vh;
      }

      header {
        padding: 32px 24px 12px;
        max-width: 1200px;
        margin: 0 auto;
      }

      header h1 {
        margin: 0 0 6px;
        font-size: clamp(1.6rem, 1.2rem + 1vw, 2.4rem);
      }

      header p {
        margin: 0;
        color: var(--muted);
      }

      .nav {
        margin-top: 8px;
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }

      .nav a {
        text-decoration: none;
        color: var(--accent);
        font-weight: 600;
        background: #eef2ff;
        padding: 6px 10px;
        border-radius: 999px;
      }

      main {
        max-width: 1200px;
        margin: 0 auto;
        padding: 12px 24px 48px;
        display: grid;
        gap: 18px;
      }

      .grid-2 {
        display: grid;
        gap: 18px;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      }

      .panel {
        background: var(--panel);
        border: 1px solid var(--border);
        border-radius: 16px;
        box-shadow: var(--shadow);
        padding: 18px;
        animation: fadeUp 420ms ease;
      }

      .panel h2 {
        margin: 0 0 12px;
        font-size: 1.1rem;
      }

      .panel h3 {
        margin: 16px 0 8px;
        font-size: 0.95rem;
      }

      label {
        display: block;
        font-weight: 600;
        margin: 10px 0 4px;
        font-size: 0.85rem;
      }

      input,
      select,
      textarea {
        width: 100%;
        padding: 8px 10px;
        border-radius: 10px;
        border: 1px solid var(--border);
        font-size: 0.9rem;
        font-family: inherit;
      }

      textarea {
        min-height: 84px;
        resize: vertical;
      }

      .row {
        display: grid;
        gap: 10px;
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      }

      button {
        appearance: none;
        border: none;
        background: var(--accent);
        color: white;
        padding: 8px 14px;
        border-radius: 10px;
        font-weight: 600;
        cursor: pointer;
        transition: transform 120ms ease, box-shadow 120ms ease;
      }

      button.secondary {
        background: var(--accent-2);
        color: #2b1d00;
      }

      button.ghost {
        background: transparent;
        border: 1px solid var(--border);
        color: var(--ink);
      }

      button:hover {
        transform: translateY(-1px);
        box-shadow: 0 6px 16px rgba(47, 107, 255, 0.2);
      }

      button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      pre {
        background: #f5f6ff;
        border: 1px solid var(--border);
        border-radius: 10px;
        padding: 10px;
        font-size: 0.8rem;
        white-space: pre-wrap;
      }

      .status {
        margin-top: 8px;
        font-size: 0.85rem;
      }

      .status.info {
        color: var(--muted);
      }

      .status.success {
        color: var(--success);
      }

      .status.error {
        color: var(--danger);
      }

      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.85rem;
      }

      th,
      td {
        text-align: left;
        padding: 8px 6px;
        border-bottom: 1px solid var(--border);
      }

      .pill {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        background: #f4f6ff;
        color: var(--muted);
        border-radius: 999px;
        padding: 4px 10px;
        font-size: 0.75rem;
      }

      .inline {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        align-items: center;
      }

      .checkbox {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 0.85rem;
      }

      @keyframes fadeUp {
        from {
          opacity: 0;
          transform: translateY(8px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @media (max-width: 640px) {
        header {
          padding: 24px 16px 8px;
        }
        main {
          padding: 12px 16px 36px;
        }
      }
    </style>
  </head>
  <body>
    <header>
      <h1>Enroll MVP Console</h1>
      <p>Baseline frontend to demonstrate the current API surface.</p>
      <nav class="nav">
        <a href="/dashboard/">Dashboard</a>
        <a href="/onboarding/">Onboarding</a>
        <a href="/applications/">Universities</a>
        <a href="/tasks/">Tasks</a>
        <a href="/documents/">Documents</a>
        <a href="/common-app/">Common App Draft</a>
        <a href="/applications-ui/">Applications quick test</a>
      </nav>
    </header>

    <main>
      <section class="panel">
        <h2>Auth and Session</h2>
        <div class="grid-2">
          <div>
            <h3>Register</h3>
            <label for="reg-username">Username</label>
            <input id="reg-username" type="text" placeholder="student01" />
            <label for="reg-email">Email</label>
            <input id="reg-email" type="email" placeholder="student@example.com" />
            <label for="reg-password">Password</label>
            <input id="reg-password" type="password" placeholder="min 6 chars" />
            <button id="register-btn">Register</button>
            <div id="register-status" class="status info"></div>
          </div>
          <div>
            <h3>Login</h3>
            <label for="login-username">Username</label>
            <input id="login-username" type="text" placeholder="student01" />
            <label for="login-password">Password</label>
            <input id="login-password" type="password" placeholder="your password" />
            <button id="login-btn">Get token</button>
            <div id="login-status" class="status info"></div>
            <h3>Active token</h3>
            <input id="token-input" type="text" placeholder="Access token" />
            <div class="inline">
              <button id="save-token-btn" class="secondary">Save token</button>
              <button id="clear-token-btn" class="ghost">Clear</button>
            </div>
            <div id="token-status" class="status info"></div>
          </div>
        </div>
      </section>

      <section class="panel">
        <h2>System</h2>
        <div class="inline">
          <button id="ping-btn">Ping</button>
          <button id="me-btn" class="secondary">Me</button>
        </div>
        <div id="system-status" class="status info"></div>
      </section>

      <section class="panel">
        <h2>Student Profile</h2>
        <div class="inline">
          <button id="profile-load-btn">Load profile</button>
          <button id="profile-save-btn" class="secondary">Save profile</button>
        </div>
        <div id="profile-status" class="status info"></div>
        <div class="row">
          <div>
            <label for="profile-full-name">Full name</label>
            <input id="profile-full-name" type="text" />
          </div>
          <div>
            <label for="profile-country">Country</label>
            <input id="profile-country" type="text" />
          </div>
          <div>
            <label for="profile-school">School name</label>
            <input id="profile-school" type="text" />
          </div>
          <div>
            <label for="profile-year">Graduation year</label>
            <input id="profile-year" type="number" />
          </div>
          <div>
            <label for="profile-major">Intended major</label>
            <input id="profile-major" type="text" />
          </div>
          <div>
            <label for="profile-gpa">GPA</label>
            <input id="profile-gpa" type="text" />
          </div>
          <div>
            <label for="profile-grades">Grades summary</label>
            <input id="profile-grades" type="text" />
          </div>
          <div>
            <label for="profile-ielts">IELTS overall</label>
            <input id="profile-ielts" type="text" />
          </div>
          <div>
            <label for="profile-ielts-date">IELTS date</label>
            <input id="profile-ielts-date" type="date" />
          </div>
          <div>
            <label for="profile-toefl">TOEFL total</label>
            <input id="profile-toefl" type="number" />
          </div>
          <div>
            <label for="profile-toefl-date">TOEFL date</label>
            <input id="profile-toefl-date" type="date" />
          </div>
          <div>
            <label for="profile-sat">SAT total</label>
            <input id="profile-sat" type="number" />
          </div>
          <div>
            <label for="profile-sat-date">SAT date</label>
            <input id="profile-sat-date" type="date" />
          </div>
          <div>
            <label for="profile-det">DET score</label>
            <input id="profile-det" type="number" />
          </div>
          <div>
            <label for="profile-det-date">DET date</label>
            <input id="profile-det-date" type="date" />
          </div>
          <div>
            <label for="profile-budget">Budget range</label>
            <select id="profile-budget">
              <option value="">-</option>
              <option value="low">low</option>
              <option value="medium">medium</option>
              <option value="high">high</option>
            </select>
          </div>
          <div>
            <label for="profile-activity-level">Activities level</label>
            <select id="profile-activity-level">
              <option value="low">low</option>
              <option value="medium">medium</option>
              <option value="high">high</option>
            </select>
          </div>
          <div>
            <label for="profile-target">Target country</label>
            <input id="profile-target" type="text" />
          </div>
          <div>
            <label for="profile-activities">Activities (comma separated)</label>
            <input id="profile-activities" type="text" />
          </div>
          <div>
            <label for="profile-honors">Honors (comma separated)</label>
            <input id="profile-honors" type="text" />
          </div>
        </div>
      </section>

      <section class="panel">
        <h2>Universities</h2>
        <div class="inline">
          <button id="universities-load-btn">Load universities</button>
          <span class="pill">GET /api/universities/</span>
        </div>
        <div id="universities-status" class="status info"></div>
        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>Name</th>
              <th>Country</th>
              <th>State</th>
              <th>Deadline</th>
            </tr>
          </thead>
          <tbody id="universities-body"></tbody>
        </table>
      </section>

      <section class="panel">
        <h2>My Universities</h2>
        <div class="grid-2">
          <div>
            <h3>Create</h3>
            <label for="my-uni-select">University</label>
            <select id="my-uni-select">
              <option value="">-- select university --</option>
            </select>
            <label for="my-uni-category">Category</label>
            <select id="my-uni-category">
              <option value="reach">reach</option>
              <option value="target" selected>target</option>
              <option value="safety">safety</option>
            </select>
            <label for="my-uni-status">Status</label>
            <select id="my-uni-status">
              <option value="planning">planning</option>
              <option value="preparing">preparing</option>
              <option value="applying">applying</option>
              <option value="submitted">submitted</option>
              <option value="admitted">admitted</option>
              <option value="rejected">rejected</option>
            </select>
            <label for="my-uni-deadline">Deadline override</label>
            <input id="my-uni-deadline" type="date" />
            <label for="my-uni-notes">Notes</label>
            <textarea id="my-uni-notes"></textarea>
            <div class="row">
              <label class="checkbox"><input id="my-uni-tests" type="checkbox" />Tests done</label>
              <label class="checkbox"><input id="my-uni-essays" type="checkbox" />Essays done</label>
              <label class="checkbox"><input id="my-uni-recs" type="checkbox" />Recs done</label>
              <label class="checkbox"><input id="my-uni-form" type="checkbox" />Form done</label>
              <label class="checkbox"><input id="my-uni-fee" type="checkbox" />Fee paid</label>
            </div>
            <button id="my-uni-create-btn">Add</button>
            <div id="my-uni-create-status" class="status info"></div>
          </div>
          <div>
            <h3>List</h3>
            <div class="inline">
              <button id="my-uni-load-btn" class="secondary">Load my universities</button>
              <span class="pill">GET /api/my-universities/</span>
            </div>
            <div id="my-uni-load-status" class="status info"></div>
            <table>
              <thead>
                <tr>
                  <th>ID</th>
                  <th>University</th>
                  <th>Category</th>
                  <th>Status</th>
                  <th>Progress</th>
                </tr>
              </thead>
              <tbody id="my-uni-body"></tbody>
            </table>
          </div>
        </div>
      </section>

      <section class="panel">
        <h2>Applications</h2>
        <div class="grid-2">
          <div>
            <h3>Create</h3>
            <label for="app-my-uni-select">Select from My Universities</label>
            <select id="app-my-uni-select">
              <option value="">-- load My Universities first --</option>
            </select>
            <button id="app-load-my-uni" class="secondary">Load My Universities</button>
            <label for="app-deadline">Deadline</label>
            <input id="app-deadline" type="date" />
            <label for="app-status">Status</label>
            <select id="app-status">
              <option value="planned">planned</option>
              <option value="in_progress">in_progress</option>
              <option value="submitted">submitted</option>
            </select>
            <button id="app-create-btn">Create application</button>
            <div id="app-create-status" class="status info"></div>
          </div>
          <div>
            <h3>List</h3>
            <div class="inline">
              <button id="app-load-btn" class="secondary">Load applications</button>
              <span class="pill">GET /api/applications/</span>
            </div>
            <div id="app-load-status" class="status info"></div>
            <table>
              <thead>
                <tr>
                  <th>ID</th>
                  <th>University</th>
                  <th>Deadline</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody id="applications-body"></tbody>
            </table>
          </div>
        </div>
      </section>

      <section class="panel">
        <div class="inline">
          <h2>Tasks</h2>
          <label class="checkbox pill">
            <input id="tasks-enabled" type="checkbox" />
            API ready
          </label>
        </div>
        <div id="tasks-availability" class="status info"></div>
        <div class="grid-2">
          <div>
            <h3>Create</h3>
            <label for="task-title">Title</label>
            <input id="task-title" type="text" />
            <label for="task-description">Description</label>
            <textarea id="task-description"></textarea>
            <label for="task-due-date">Due date</label>
            <input id="task-due-date" type="date" />
            <label for="task-status">Status</label>
            <select id="task-status">
              <option value="planned">planned</option>
              <option value="in_progress">in_progress</option>
              <option value="done">done</option>
            </select>
            <label for="task-priority">Priority</label>
            <select id="task-priority">
              <option value="low">low</option>
              <option value="medium" selected>medium</option>
              <option value="high">high</option>
            </select>
            <label for="task-application-id">Application ID (optional)</label>
            <input id="task-application-id" type="number" />
            <button id="task-create-btn" data-feature="tasks">Create task</button>
            <div id="task-create-status" class="status info"></div>

            <h3>Generate from templates</h3>
            <label for="task-generate-application-id">Application ID (optional)</label>
            <input id="task-generate-application-id" type="number" />
            <button id="task-generate-btn" data-feature="tasks" class="secondary">Generate tasks</button>
            <div id="task-generate-status" class="status info"></div>
          </div>
          <div>
            <h3>List</h3>
            <label for="task-filter-status">Status filter</label>
            <input id="task-filter-status" type="text" placeholder="planned / in_progress / done" />
            <label for="task-filter-application">Application ID filter</label>
            <input id="task-filter-application" type="number" />
            <button id="task-load-btn" data-feature="tasks" class="secondary">Load tasks</button>
            <div id="task-load-status" class="status info"></div>
            <table>
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Title</th>
                  <th>Status</th>
                  <th>Due</th>
                  <th>Priority</th>
                </tr>
              </thead>
              <tbody id="tasks-body"></tbody>
            </table>
          </div>
        </div>
      </section>

      <section class="panel">
        <div class="inline">
          <h2>Documents</h2>
          <label class="checkbox pill">
            <input id="documents-enabled" type="checkbox" />
            API ready
          </label>
        </div>
        <div id="documents-availability" class="status info"></div>
        <div class="grid-2">
          <div>
            <h3>Create document</h3>
            <label for="doc-title">Title</label>
            <input id="doc-title" type="text" />
            <label for="doc-type">Type</label>
            <select id="doc-type">
              <option value="essay">essay</option>
              <option value="resume">resume</option>
              <option value="recommendation_notes">recommendation_notes</option>
              <option value="other">other</option>
            </select>
            <label for="doc-application-id">Application ID (optional)</label>
            <input id="doc-application-id" type="number" />
            <button id="doc-create-btn" data-feature="documents">Create document</button>
            <div id="doc-create-status" class="status info"></div>

            <h3>Add version</h3>
            <label for="doc-version-id">Document ID</label>
            <input id="doc-version-id" type="number" />
            <label for="doc-version-content">Content</label>
            <textarea id="doc-version-content"></textarea>
            <label for="doc-version-created-by">Created by</label>
            <select id="doc-version-created-by">
              <option value="user">user</option>
              <option value="ai">ai</option>
            </select>
            <button id="doc-version-btn" data-feature="documents" class="secondary">Add version</button>
            <div id="doc-version-status" class="status info"></div>
          </div>
          <div>
            <h3>List</h3>
            <button id="doc-load-btn" data-feature="documents" class="secondary">Load documents</button>
            <div id="doc-load-status" class="status info"></div>
            <table>
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Title</th>
                  <th>Type</th>
                </tr>
              </thead>
              <tbody id="documents-body"></tbody>
            </table>
          </div>
        </div>
      </section>

      <section class="panel">
        <div class="inline">
          <h2>AI Assistant</h2>
          <label class="checkbox pill">
            <input id="ai-enabled" type="checkbox" />
            API ready
          </label>
        </div>
        <div id="ai-availability" class="status info"></div>
        <label for="ai-endpoint">Endpoint</label>
        <select id="ai-endpoint">
          <option value="/api/ai/next-step/">/api/ai/next-step/</option>
          <option value="/api/ai/document-draft/">/api/ai/document-draft/</option>
          <option value="/api/ai/document-feedback/">/api/ai/document-feedback/</option>
          <option value="/api/ai/commonapp-draft/">/api/ai/commonapp-draft/</option>
        </select>
        <label for="ai-payload">Payload (JSON)</label>
        <textarea id="ai-payload" placeholder='{"context_type":"profile","context_id":1}'></textarea>
        <button id="ai-send-btn" data-feature="ai">Send request</button>
        <div id="ai-status" class="status info"></div>
        <h3>Response</h3>
        <pre id="ai-response">Waiting for response...</pre>
      </section>
    </main>

    <script>
      const tokenStorageKey = "enroll_token";

      const el = (id) => document.getElementById(id);

      const tokenInput = el("token-input");
      const tokenStatus = el("token-status");

      function setStatus(target, message, type = "info") {
        target.textContent = message;
        target.className = `status ${type}`;
      }

      function getToken() {
        return tokenInput.value.trim();
      }

      function saveToken(token) {
        tokenInput.value = token;
        localStorage.setItem(tokenStorageKey, token);
        setStatus(tokenStatus, token ? "Token stored." : "Token cleared.", "info");
      }

      function authHeaders() {
        const token = getToken();
        return token ? { Authorization: `Bearer ${token}` } : {};
      }

      async function request(path, options = {}) {
        const response = await fetch(path, {
          headers: {
            "Content-Type": "application/json",
            ...authHeaders(),
            ...options.headers,
          },
          ...options,
        });
        let data = null;
        const contentType = response.headers.get("content-type") || "";
        if (contentType.includes("application/json")) {
          data = await response.json();
        } else {
          data = await response.text();
        }
        if (!response.ok) {
          const message = data?.detail || data?.error || JSON.stringify(data) || response.statusText;
          throw new Error(message);
        }
        return data;
      }

      function parseList(value) {
        if (!value) return [];
        return value
          .split(",")
          .map((item) => item.trim())
          .filter(Boolean);
      }

      function joinList(list) {
        if (!Array.isArray(list)) return "";
        return list.join(", ");
      }

      function toNumber(value) {
        if (value === "" || value === null || value === undefined) return null;
        const num = Number(value);
        return Number.isNaN(num) ? null : num;
      }

      function toValue(value) {
        return value === null || value === undefined ? "" : value;
      }

      function setupFeatureToggle(key, message, defaultEnabled = true) {
        const toggle = el(`${key}-enabled`);
        const status = el(`${key}-availability`);
        if (!toggle || !status) return;
        const storageKey = `feature_${key}`;
        const apply = () => {
          const enabled = toggle.checked;
          localStorage.setItem(storageKey, enabled ? "1" : "0");
          document.querySelectorAll(`[data-feature='${key}']`).forEach((button) => {
            button.disabled = !enabled;
          });
          setStatus(status, enabled ? "API enabled." : message, enabled ? "success" : "info");
        };
        const stored = localStorage.getItem(storageKey);
        toggle.checked = stored === null ? defaultEnabled : stored === "1";
        toggle.addEventListener("change", apply);
        apply();
      }

      function renderUniversities(items) {
        const body = el("universities-body");
        body.innerHTML = items
          .map(
            (item) => `
              <tr>
                <td>${item.id}</td>
                <td>${item.name}</td>
                <td>${item.country || "-"}</td>
                <td>${item.state || "-"}</td>
                <td>${item.main_deadline || "-"}</td>
              </tr>
            `
          )
          .join("");

        const select = el("my-uni-select");
        select.innerHTML = `<option value="">-- select university --</option>` + items
          .map((item) => `<option value="${item.id}">${item.name}</option>`)
          .join("");
      }

      function renderMyUniversities(items) {
        const body = el("my-uni-body");
        body.innerHTML = items
          .map((item) => `
              <tr>
                <td>${item.id}</td>
                <td>${item.university?.name || "-"}</td>
                <td>${item.category}</td>
                <td>${item.status}</td>
                <td>${item.progress_percent ?? 0}%</td>
              </tr>
            `)
          .join("");
        renderApplicationsSelect(items);
      }

      function renderApplicationsSelect(items) {
        const select = el("app-my-uni-select");
        select.innerHTML = "";
        if (!items.length) {
          const option = document.createElement("option");
          option.value = "";
          option.textContent = "-- list empty: add in My Universities --";
          select.appendChild(option);
          return;
        }
        const placeholder = document.createElement("option");
        placeholder.value = "";
        placeholder.textContent = "-- select university --";
        select.appendChild(placeholder);
        items.forEach((item) => {
          if (!item.university) return;
          const option = document.createElement("option");
          option.value = item.university.id;
          option.textContent = item.university.name;
          select.appendChild(option);
        });
      }

      function renderApplications(items) {
        const body = el("applications-body");
        body.innerHTML = items
          .map((item) => `
              <tr>
                <td>${item.id}</td>
                <td>${item.university?.name || item.university_name || "-"}</td>
                <td>${item.deadline_date || "-"}</td>
                <td>${item.status}</td>
              </tr>
            `)
          .join("");
      }

      function renderTasks(items) {
        const body = el("tasks-body");
        body.innerHTML = items
          .map((item) => `
              <tr>
                <td>${item.id}</td>
                <td>${item.title || "-"}</td>
                <td>${item.status || "-"}</td>
                <td>${item.due_date || "-"}</td>
                <td>${item.priority || "-"}</td>
              </tr>
            `)
          .join("");
      }

      function renderDocuments(items) {
        const body = el("documents-body");
        body.innerHTML = items
          .map((item) => `
              <tr>
                <td>${item.id}</td>
                <td>${item.title || "-"}</td>
                <td>${item.type || "-"}</td>
              </tr>
            `)
          .join("");
      }

      async function registerUser() {
        const status = el("register-status");
        setStatus(status, "Registering...");
        try {
          const payload = {
            username: el("reg-username").value.trim(),
            email: el("reg-email").value.trim(),
            password: el("reg-password").value,
          };
          await request("/api/auth/register/", {
            method: "POST",
            body: JSON.stringify(payload),
          });
          setStatus(status, "Registered. Now login to get token.", "success");
        } catch (error) {
          setStatus(status, error.message, "error");
        }
      }

      async function loginUser() {
        const status = el("login-status");
        setStatus(status, "Requesting token...");
        try {
          const payload = {
            username: el("login-username").value.trim(),
            password: el("login-password").value,
          };
          const data = await request("/api/auth/token/", {
            method: "POST",
            body: JSON.stringify(payload),
          });
          saveToken(data.access || "");
          setStatus(status, "Token received.", "success");
        } catch (error) {
          setStatus(status, error.message, "error");
        }
      }

      async function ping() {
        const status = el("system-status");
        setStatus(status, "Pinging...");
        try {
          const data = await request("/api/ping/");
          setStatus(status, JSON.stringify(data), "success");
        } catch (error) {
          setStatus(status, error.message, "error");
        }
      }

      async function loadMe() {
        const status = el("system-status");
        setStatus(status, "Loading profile...");
        try {
          const data = await request("/api/me/");
          setStatus(status, `Hello ${data.username}`, "success");
        } catch (error) {
          setStatus(status, error.message, "error");
        }
      }

      async function loadProfile() {
        const status = el("profile-status");
        setStatus(status, "Loading profile...");
        try {
          const data = await request("/api/auth/profile/");
          el("profile-full-name").value = toValue(data.full_name);
          el("profile-country").value = toValue(data.country);
          el("profile-school").value = toValue(data.school_name);
          el("profile-year").value = toValue(data.graduation_year);
          el("profile-major").value = toValue(data.intended_major);
          el("profile-gpa").value = toValue(data.gpa);
          el("profile-grades").value = toValue(data.grades_summary);
          el("profile-ielts").value = toValue(data.ielts_overall);
          el("profile-ielts-date").value = toValue(data.ielts_date);
          el("profile-toefl").value = toValue(data.toefl_total);
          el("profile-toefl-date").value = toValue(data.toefl_date);
          el("profile-sat").value = toValue(data.sat_total);
          el("profile-sat-date").value = toValue(data.sat_date);
          el("profile-det").value = toValue(data.det_score);
          el("profile-det-date").value = toValue(data.det_date);
          el("profile-budget").value = toValue(data.budget_range);
          el("profile-activity-level").value = toValue(data.activities_level || "low");
          el("profile-target").value = toValue(data.target_country || "USA");
          el("profile-activities").value = joinList(data.activities);
          el("profile-honors").value = joinList(data.honors);
          setStatus(status, "Profile loaded.", "success");
        } catch (error) {
          setStatus(status, error.message, "error");
        }
      }

      async function saveProfile() {
        const status = el("profile-status");
        setStatus(status, "Saving profile...");
        try {
          const payload = {
            full_name: el("profile-full-name").value.trim(),
            country: el("profile-country").value.trim(),
            school_name: el("profile-school").value.trim(),
            graduation_year: toNumber(el("profile-year").value),
            intended_major: el("profile-major").value.trim(),
            gpa: el("profile-gpa").value.trim() || null,
            grades_summary: el("profile-grades").value.trim(),
            ielts_overall: el("profile-ielts").value.trim() || null,
            ielts_date: el("profile-ielts-date").value || null,
            toefl_total: toNumber(el("profile-toefl").value),
            toefl_date: el("profile-toefl-date").value || null,
            sat_total: toNumber(el("profile-sat").value),
            sat_date: el("profile-sat-date").value || null,
            det_score: toNumber(el("profile-det").value),
            det_date: el("profile-det-date").value || null,
            activities: parseList(el("profile-activities").value),
            honors: parseList(el("profile-honors").value),
            budget_range: el("profile-budget").value || "",
            activities_level: el("profile-activity-level").value || "low",
            target_country: el("profile-target").value.trim() || "USA",
          };
          await request("/api/auth/profile/", {
            method: "PUT",
            body: JSON.stringify(payload),
          });
          setStatus(status, "Profile saved.", "success");
        } catch (error) {
          setStatus(status, error.message, "error");
        }
      }

      async function loadUniversities() {
        const status = el("universities-status");
        setStatus(status, "Loading universities...");
        try {
          const data = await request("/api/universities/");
          renderUniversities(data);
          setStatus(status, `Loaded ${data.length} universities.`, "success");
        } catch (error) {
          setStatus(status, error.message, "error");
        }
      }

      async function loadMyUniversities() {
        const status = el("my-uni-load-status");
        setStatus(status, "Loading list...");
        try {
          const data = await request("/api/my-universities/");
          renderMyUniversities(data);
          setStatus(status, `Loaded ${data.length} entries.`, "success");
        } catch (error) {
          setStatus(status, error.message, "error");
        }
      }

      async function createMyUniversity() {
        const status = el("my-uni-create-status");
        setStatus(status, "Creating entry...");
        try {
          const payload = {
            university_id: toNumber(el("my-uni-select").value),
            category: el("my-uni-category").value,
            status: el("my-uni-status").value,
            tests_done: el("my-uni-tests").checked,
            essays_done: el("my-uni-essays").checked,
            recommendations_done: el("my-uni-recs").checked,
            application_form_done: el("my-uni-form").checked,
            application_fee_paid: el("my-uni-fee").checked,
            deadline_override: el("my-uni-deadline").value || null,
            notes: el("my-uni-notes").value.trim(),
          };
          if (!payload.university_id) {
            throw new Error("Select a university first.");
          }
          await request("/api/my-universities/", {
            method: "POST",
            body: JSON.stringify(payload),
          });
          setStatus(status, "Added to my universities.", "success");
          await loadMyUniversities();
        } catch (error) {
          setStatus(status, error.message, "error");
        }
      }

      async function loadApplications() {
        const status = el("app-load-status");
        setStatus(status, "Loading applications...");
        try {
          const data = await request("/api/applications/");
          renderApplications(data);
          setStatus(status, `Loaded ${data.length} applications.`, "success");
        } catch (error) {
          setStatus(status, error.message, "error");
        }
      }

      async function createApplication() {
        const status = el("app-create-status");
        setStatus(status, "Creating application...");
        try {
          const selectedUniversityId = el("app-my-uni-select").value;
          if (!selectedUniversityId) {
            throw new Error("Select university from My Universities.");
          }
          const payload = {
            university_id: Number(selectedUniversityId),
            deadline_date: el("app-deadline").value || null,
            status: el("app-status").value,
          };
          await request("/api/applications/", {
            method: "POST",
            body: JSON.stringify(payload),
          });
          setStatus(status, "Application created.", "success");
          await loadApplications();
        } catch (error) {
          setStatus(status, error.message, "error");
        }
      }

      async function loadTasks() {
        const status = el("task-load-status");
        setStatus(status, "Loading tasks...");
        try {
          const params = new URLSearchParams();
          const statusFilter = el("task-filter-status").value.trim();
          const applicationFilter = el("task-filter-application").value.trim();
          if (statusFilter) params.append("status", statusFilter);
          if (applicationFilter) params.append("application_id", applicationFilter);
          const query = params.toString();
          const url = query ? `/api/tasks/?${query}` : "/api/tasks/";
          const data = await request(url);
          renderTasks(data);
          setStatus(status, `Loaded ${data.length} tasks.`, "success");
        } catch (error) {
          setStatus(status, error.message, "error");
        }
      }

      async function createTask() {
        const status = el("task-create-status");
        setStatus(status, "Creating task...");
        try {
          const payload = {
            title: el("task-title").value.trim(),
            description: el("task-description").value.trim(),
            due_date: el("task-due-date").value || null,
            status: el("task-status").value.trim(),
            priority: el("task-priority").value,
            application_id: toNumber(el("task-application-id").value),
          };
          if (!payload.application_id) {
            delete payload.application_id;
          }
          await request("/api/tasks/", {
            method: "POST",
            body: JSON.stringify(payload),
          });
          setStatus(status, "Task created.", "success");
          await loadTasks();
        } catch (error) {
          setStatus(status, error.message, "error");
        }
      }

      async function generateTasks() {
        const status = el("task-generate-status");
        setStatus(status, "Generating tasks...");
        try {
          const payload = {
            application_id: toNumber(el("task-generate-application-id").value),
          };
          if (!payload.application_id) {
            delete payload.application_id;
          }
          const data = await request("/api/tasks/generate/", {
            method: "POST",
            body: JSON.stringify(payload),
          });
          setStatus(status, "Tasks generated.", "success");
          if (Array.isArray(data)) {
            renderTasks(data);
          } else {
            await loadTasks();
          }
        } catch (error) {
          setStatus(status, error.message, "error");
        }
      }

      async function loadDocuments() {
        const status = el("doc-load-status");
        setStatus(status, "Loading documents...");
        try {
          const data = await request("/api/documents/");
          renderDocuments(data);
          setStatus(status, `Loaded ${data.length} documents.`, "success");
        } catch (error) {
          setStatus(status, error.message, "error");
        }
      }

      async function createDocument() {
        const status = el("doc-create-status");
        setStatus(status, "Creating document...");
        try {
          const payload = {
            title: el("doc-title").value.trim(),
            type: el("doc-type").value,
            application_id: toNumber(el("doc-application-id").value),
          };
          if (!payload.application_id) {
            delete payload.application_id;
          }
          await request("/api/documents/", {
            method: "POST",
            body: JSON.stringify(payload),
          });
          setStatus(status, "Document created.", "success");
          await loadDocuments();
        } catch (error) {
          setStatus(status, error.message, "error");
        }
      }

      async function createDocumentVersion() {
        const status = el("doc-version-status");
        setStatus(status, "Creating version...");
        try {
          const docId = toNumber(el("doc-version-id").value);
          if (!docId) {
            throw new Error("Provide document ID.");
          }
          const payload = {
            content: el("doc-version-content").value.trim(),
            created_by: el("doc-version-created-by").value,
          };
          await request(`/api/documents/${docId}/versions/`, {
            method: "POST",
            body: JSON.stringify(payload),
          });
          setStatus(status, "Version added.", "success");
        } catch (error) {
          setStatus(status, error.message, "error");
        }
      }

      async function sendAiRequest() {
        const status = el("ai-status");
        const responseBox = el("ai-response");
        setStatus(status, "Sending request...");
        try {
          const endpoint = el("ai-endpoint").value;
          const payloadText = el("ai-payload").value.trim() || "{}";
          let payload = {};
          try {
            payload = JSON.parse(payloadText);
          } catch (parseError) {
            throw new Error("Payload must be valid JSON.");
          }
          const data = await request(endpoint, {
            method: "POST",
            body: JSON.stringify(payload),
          });
          responseBox.textContent = JSON.stringify(data, null, 2);
          setStatus(status, "AI response received.", "success");
        } catch (error) {
          responseBox.textContent = "";
          setStatus(status, error.message, "error");
        }
      }

      document.addEventListener("DOMContentLoaded", () => {
        const stored = localStorage.getItem(tokenStorageKey) || "";
        tokenInput.value = stored;

        setupFeatureToggle("tasks", "Tasks API disabled.");
        setupFeatureToggle("documents", "Documents API disabled.");
        setupFeatureToggle("ai", "AI API disabled.");

        el("register-btn").addEventListener("click", registerUser);
        el("login-btn").addEventListener("click", loginUser);
        el("save-token-btn").addEventListener("click", () => saveToken(getToken()));
        el("clear-token-btn").addEventListener("click", () => saveToken(""));
        el("ping-btn").addEventListener("click", ping);
        el("me-btn").addEventListener("click", loadMe);
        el("profile-load-btn").addEventListener("click", loadProfile);
        el("profile-save-btn").addEventListener("click", saveProfile);
        el("universities-load-btn").addEventListener("click", loadUniversities);
        el("my-uni-load-btn").addEventListener("click", loadMyUniversities);
        el("my-uni-create-btn").addEventListener("click", createMyUniversity);
        el("app-load-my-uni").addEventListener("click", loadMyUniversities);
        el("app-load-btn").addEventListener("click", loadApplications);
        el("app-create-btn").addEventListener("click", createApplication);

        el("task-load-btn").addEventListener("click", loadTasks);
        el("task-create-btn").addEventListener("click", createTask);
        el("task-generate-btn").addEventListener("click", generateTasks);
        el("doc-load-btn").addEventListener("click", loadDocuments);
        el("doc-create-btn").addEventListener("click", createDocument);
        el("doc-version-btn").addEventListener("click", createDocumentVersion);
        el("ai-send-btn").addEventListener("click", sendAiRequest);
      });
    </script>
  </body>
</html>
