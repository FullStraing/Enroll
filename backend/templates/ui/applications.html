{% extends "ui/base.html" %}
{% load static %}

{% block page_title %}Universities{% endblock %}
{% block page_heading %}Universities{% endblock %}
{% block page_subtitle %}Build your university list and track progress.{% endblock %}

{% block content %}
  <section class="card">
    <div class="card-title">
      <img src="{% static 'icons/universities.svg' %}" alt="" />
      <h2>Overview</h2>
    </div>
    <p>Applications workflow will be finalized later.</p>
  </section>

  <section class="card">
    <div class="card-title">
      <img src="{% static 'icons/universities.svg' %}" alt="" />
      <h2>Available universities</h2>
    </div>
    <div class="form-actions">
      <button id="load-universities">Load universities</button>
    </div>
    <div id="universities-status" class="status info"></div>
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>Name</th>
            <th>Country</th>
            <th>State</th>
          </tr>
        </thead>
        <tbody id="universities-body"></tbody>
      </table>
    </div>
  </section>

  <section class="card">
    <div class="card-title">
      <img src="{% static 'icons/onboarding.svg' %}" alt="" />
      <h2>My Universities</h2>
    </div>
    <div class="grid-2">
      <div>
        <label for="my-uni-select">University</label>
        <select id="my-uni-select">
          <option value="">-- load list first --</option>
        </select>
        <label for="my-uni-category">Category</label>
        <select id="my-uni-category">
          <option value="reach">reach</option>
          <option value="target" selected>target</option>
          <option value="safety">safety</option>
        </select>
        <label for="my-uni-status">Status</label>
        <select id="my-uni-status">
          <option value="planning">planning</option>
          <option value="preparing">preparing</option>
          <option value="applying">applying</option>
          <option value="submitted">submitted</option>
          <option value="admitted">admitted</option>
          <option value="rejected">rejected</option>
        </select>
        <label for="my-uni-notes">Notes</label>
        <textarea id="my-uni-notes"></textarea>
        <div class="form-actions">
          <button id="add-my-university" class="secondary">Add to My Universities</button>
        </div>
        <div id="my-uni-create-status" class="status info"></div>
      </div>
      <div>
        <div class="form-actions">
          <button id="load-my-universities" class="secondary">Load My Universities</button>
        </div>
        <div id="my-uni-load-status" class="status info"></div>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>ID</th>
                <th>University</th>
                <th>Category</th>
                <th>Status</th>
                <th>Progress</th>
              </tr>
            </thead>
            <tbody id="my-universities-body"></tbody>
          </table>
        </div>
      </div>
    </div>
  </section>
{% endblock %}

{% block scripts %}
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const api = window.api;
      if (!api || !api.request) {
        console.error("API helpers not loaded.");
        return;
      }
      const { request, setStatus } = api;
      const { createSkeletonRows, setButtonLoading } = window.ui || {};

      function renderUniversities(items) {
        const body = document.getElementById("universities-body");
        body.innerHTML = items
          .map(
            (item) => `
              <tr>
                <td>${item.id}</td>
                <td>${item.name}</td>
                <td>${item.country || "-"}</td>
                <td>${item.state || "-"}</td>
              </tr>
            `
          )
          .join("");

        const select = document.getElementById("my-uni-select");
        select.innerHTML = `<option value="">-- select university --</option>` + items
          .map((item) => `<option value="${item.id}">${item.name}</option>`)
          .join("");
      }

      function renderMyUniversities(items) {
        const body = document.getElementById("my-universities-body");
        body.innerHTML = items
          .map(
            (item) => `
              <tr>
                <td>${item.id}</td>
                <td>${item.university?.name || "-"}</td>
                <td>${item.category}</td>
                <td>${item.status}</td>
                <td>${item.progress_percent ?? 0}%</td>
              </tr>
            `
          )
          .join("");
      }

      async function loadUniversities() {
        const status = document.getElementById("universities-status");
        const button = document.getElementById("load-universities");
        if (setButtonLoading) setButtonLoading(button, true);
        setStatus(status, "Loading universities...");
        const body = document.getElementById("universities-body");
        if (body && createSkeletonRows) {
          body.innerHTML = createSkeletonRows(4, 4);
        }
        try {
          const data = await request("/api/universities/");
          renderUniversities(data);
          setStatus(status, `Loaded ${data.length}.`, "success");
        } catch (error) {
          setStatus(status, error.message, "error");
        } finally {
          if (setButtonLoading) setButtonLoading(button, false);
        }
      }

      async function loadMyUniversities() {
        const status = document.getElementById("my-uni-load-status");
        const button = document.getElementById("load-my-universities");
        if (setButtonLoading) setButtonLoading(button, true);
        setStatus(status, "Loading list...");
        const body = document.getElementById("my-universities-body");
        if (body && createSkeletonRows) {
          body.innerHTML = createSkeletonRows(5, 4);
        }
        try {
          const data = await request("/api/my-universities/");
          renderMyUniversities(data);
          setStatus(status, `Loaded ${data.length}.`, "success");
        } catch (error) {
          setStatus(status, error.message, "error");
        } finally {
          if (setButtonLoading) setButtonLoading(button, false);
        }
      }

      async function addMyUniversity() {
        const status = document.getElementById("my-uni-create-status");
        const button = document.getElementById("add-my-university");
        if (setButtonLoading) setButtonLoading(button, true);
        setStatus(status, "Adding...");
        try {
          const universityId = document.getElementById("my-uni-select").value;
          if (!universityId) {
            throw new Error("Select a university.");
          }
          await request("/api/my-universities/", {
            method: "POST",
            body: JSON.stringify({
              university_id: Number(universityId),
              category: document.getElementById("my-uni-category").value,
              status: document.getElementById("my-uni-status").value,
              notes: document.getElementById("my-uni-notes").value.trim(),
            }),
          });
          setStatus(status, "Added.", "success");
          await loadMyUniversities();
        } catch (error) {
          setStatus(status, error.message, "error");
        } finally {
          if (setButtonLoading) setButtonLoading(button, false);
        }
      }

      document.getElementById("load-universities").addEventListener("click", loadUniversities);
      document.getElementById("load-my-universities").addEventListener("click", loadMyUniversities);
      document.getElementById("add-my-university").addEventListener("click", addMyUniversity);
    });
  </script>
{% endblock %}
