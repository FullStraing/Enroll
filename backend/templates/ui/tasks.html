{% extends "ui/base.html" %}
{% load static %}

{% block page_title %}Tasks{% endblock %}
{% block page_heading %}Tasks{% endblock %}
{% block page_subtitle %}Manage roadmap tasks and generate a baseline checklist.{% endblock %}

{% block content %}
  <section class="card">
    <div class="card-title">
      <img src="{% static 'icons/tasks.svg' %}" alt="" />
      <h2>Create task</h2>
    </div>
    <div class="grid-2">
      <div>
        <label for="task-title">Title</label>
        <input id="task-title" type="text" />
        <label for="task-description">Description</label>
        <textarea id="task-description"></textarea>
        <label for="task-due-date">Due date</label>
        <input id="task-due-date" type="date" />
        <label for="task-status">Status</label>
        <select id="task-status">
          <option value="planned">planned</option>
          <option value="in_progress">in_progress</option>
          <option value="done">done</option>
        </select>
        <label for="task-priority">Priority</label>
        <select id="task-priority">
          <option value="low">low</option>
          <option value="medium" selected>medium</option>
          <option value="high">high</option>
        </select>
        <label for="task-application-id">Application ID (optional)</label>
        <input id="task-application-id" type="number" />
        <div class="form-actions">
          <button id="create-task">Create task</button>
        </div>
        <div id="task-create-status" class="status info"></div>
      </div>
      <div>
        <div class="card-title">
          <img src="{% static 'icons/dashboard.svg' %}" alt="" />
          <h2>Generate from templates</h2>
        </div>
        <label for="task-generate-application">Application ID (optional)</label>
        <input id="task-generate-application" type="number" />
        <div class="form-actions">
          <button id="generate-tasks" class="secondary">Generate tasks</button>
        </div>
        <div id="task-generate-status" class="status info"></div>
      </div>
    </div>
  </section>

  <section class="card">
    <div class="card-title">
      <img src="{% static 'icons/tasks.svg' %}" alt="" />
      <h2>Task list</h2>
    </div>
    <div class="grid-2">
      <div>
        <label for="task-filter-status">Status filter</label>
        <input id="task-filter-status" type="text" placeholder="planned / in_progress / done" />
        <label for="task-filter-application">Application ID filter</label>
        <input id="task-filter-application" type="number" />
        <div class="form-actions">
          <button id="load-tasks" class="secondary">Load tasks</button>
        </div>
        <div id="task-load-status" class="status info"></div>
      </div>
    </div>
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>Title</th>
            <th>Status</th>
            <th>Due</th>
            <th>Priority</th>
          </tr>
        </thead>
        <tbody id="tasks-body"></tbody>
      </table>
    </div>
  </section>
{% endblock %}

{% block scripts %}
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const api = window.api;
      if (!api || !api.request) {
        console.error("API helpers not loaded.");
        return;
      }
      const { request, setStatus, toNumber } = api;
      const { createSkeletonRows, setButtonLoading } = window.ui || {};

      function renderTasks(items) {
        const body = document.getElementById("tasks-body");
        body.innerHTML = items
          .map(
            (item) => `
              <tr>
                <td>${item.id}</td>
                <td>${item.title}</td>
                <td>${item.status}</td>
                <td>${item.due_date || "-"}</td>
                <td>${item.priority}</td>
              </tr>
            `
          )
          .join("");
      }

      async function loadTasks() {
        const status = document.getElementById("task-load-status");
        const button = document.getElementById("load-tasks");
        if (setButtonLoading) setButtonLoading(button, true);
        setStatus(status, "Loading tasks...");
        const body = document.getElementById("tasks-body");
        if (body && createSkeletonRows) {
          body.innerHTML = createSkeletonRows(5, 4);
        }
        try {
          const params = new URLSearchParams();
          const statusValue = document.getElementById("task-filter-status").value.trim();
          const appValue = document.getElementById("task-filter-application").value.trim();
          if (statusValue) params.append("status", statusValue);
          if (appValue) params.append("application_id", appValue);
          const query = params.toString();
          const url = query ? `/api/tasks/?${query}` : "/api/tasks/";
          const data = await request(url);
          renderTasks(data);
          setStatus(status, `Loaded ${data.length}.`, "success");
        } catch (error) {
          setStatus(status, error.message, "error");
        } finally {
          if (setButtonLoading) setButtonLoading(button, false);
        }
      }

      async function createTask() {
        const status = document.getElementById("task-create-status");
        const button = document.getElementById("create-task");
        if (setButtonLoading) setButtonLoading(button, true);
        setStatus(status, "Creating task...");
        try {
          await request("/api/tasks/", {
            method: "POST",
            body: JSON.stringify({
              title: document.getElementById("task-title").value.trim(),
              description: document.getElementById("task-description").value.trim(),
              due_date: document.getElementById("task-due-date").value || null,
              status: document.getElementById("task-status").value,
              priority: document.getElementById("task-priority").value,
              application_id: toNumber(document.getElementById("task-application-id").value),
            }),
          });
          setStatus(status, "Task created.", "success");
          await loadTasks();
        } catch (error) {
          setStatus(status, error.message, "error");
        } finally {
          if (setButtonLoading) setButtonLoading(button, false);
        }
      }

      async function generateTasks() {
        const status = document.getElementById("task-generate-status");
        const button = document.getElementById("generate-tasks");
        if (setButtonLoading) setButtonLoading(button, true);
        setStatus(status, "Generating tasks...");
        try {
          const payload = {
            application_id: toNumber(document.getElementById("task-generate-application").value),
          };
          if (!payload.application_id) {
            delete payload.application_id;
          }
          await request("/api/tasks/generate/", {
            method: "POST",
            body: JSON.stringify(payload),
          });
          setStatus(status, "Tasks generated.", "success");
          await loadTasks();
        } catch (error) {
          setStatus(status, error.message, "error");
        } finally {
          if (setButtonLoading) setButtonLoading(button, false);
        }
      }

      document.getElementById("load-tasks").addEventListener("click", loadTasks);
      document.getElementById("create-task").addEventListener("click", createTask);
      document.getElementById("generate-tasks").addEventListener("click", generateTasks);
    });
  </script>
{% endblock %}
