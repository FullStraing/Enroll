{% extends "ui/base.html" %}

{% block content %}
  <section class="card">
    <h2>Documents</h2>
    <p>Store drafts and manage versions.</p>
  </section>

  <section class="card">
    <div class="grid-2">
      <div>
        <h2>Create document</h2>
        <label for="doc-title">Title</label>
        <input id="doc-title" type="text" />
        <label for="doc-type">Type</label>
        <select id="doc-type">
          <option value="essay">essay</option>
          <option value="resume">resume</option>
          <option value="recommendation_notes">recommendation_notes</option>
          <option value="other">other</option>
        </select>
        <label for="doc-application-id">Application ID (optional)</label>
        <input id="doc-application-id" type="number" />
        <button id="create-document">Create document</button>
        <div id="document-create-status" class="status info"></div>
      </div>
      <div>
        <h2>Add version</h2>
        <label for="doc-version-id">Document ID</label>
        <input id="doc-version-id" type="number" />
        <label for="doc-version-content">Content</label>
        <textarea id="doc-version-content"></textarea>
        <label for="doc-version-created-by">Created by</label>
        <select id="doc-version-created-by">
          <option value="user">user</option>
          <option value="ai">ai</option>
        </select>
        <button id="create-version" class="secondary">Add version</button>
        <div id="document-version-status" class="status info"></div>
      </div>
    </div>
  </section>

  <section class="card">
    <h2>Document list</h2>
    <button id="load-documents" class="secondary">Load documents</button>
    <div id="document-load-status" class="status info"></div>
    <table>
      <thead>
        <tr>
          <th>ID</th>
          <th>Title</th>
          <th>Type</th>
        </tr>
      </thead>
      <tbody id="documents-body"></tbody>
    </table>
  </section>
{% endblock %}

{% block scripts %}
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const api = window.api;
      if (!api || !api.request) {
        console.error("API helpers not loaded.");
        return;
      }
      const { request, setStatus, toNumber } = api;

      function renderDocuments(items) {
        const body = document.getElementById("documents-body");
        body.innerHTML = items
          .map(
            (item) => `
              <tr>
                <td>${item.id}</td>
                <td>${item.title}</td>
                <td>${item.type}</td>
              </tr>
            `
          )
          .join("");
      }

      async function loadDocuments() {
        const status = document.getElementById("document-load-status");
        setStatus(status, "Loading documents...");
        try {
          const data = await request("/api/documents/");
          renderDocuments(data);
          setStatus(status, `Loaded ${data.length}.`, "success");
        } catch (error) {
          setStatus(status, error.message, "error");
        }
      }

      async function createDocument() {
        const status = document.getElementById("document-create-status");
        setStatus(status, "Creating document...");
        try {
          await request("/api/documents/", {
            method: "POST",
            body: JSON.stringify({
              title: document.getElementById("doc-title").value.trim(),
              type: document.getElementById("doc-type").value,
              application_id: toNumber(document.getElementById("doc-application-id").value),
            }),
          });
          setStatus(status, "Document created.", "success");
          await loadDocuments();
        } catch (error) {
          setStatus(status, error.message, "error");
        }
      }

      async function addVersion() {
        const status = document.getElementById("document-version-status");
        setStatus(status, "Adding version...");
        try {
          const docId = toNumber(document.getElementById("doc-version-id").value);
          if (!docId) {
            throw new Error("Provide document ID.");
          }
          await request(`/api/documents/${docId}/versions/`, {
            method: "POST",
            body: JSON.stringify({
              content: document.getElementById("doc-version-content").value.trim(),
              created_by: document.getElementById("doc-version-created-by").value,
            }),
          });
          setStatus(status, "Version added.", "success");
        } catch (error) {
          setStatus(status, error.message, "error");
        }
      }

      document.getElementById("load-documents").addEventListener("click", loadDocuments);
      document.getElementById("create-document").addEventListener("click", createDocument);
      document.getElementById("create-version").addEventListener("click", addVersion);
    });
  </script>
{% endblock %}
